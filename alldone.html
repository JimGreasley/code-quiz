<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HS All Done</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="styles.css"> -->
</head>

<body>

    <!-- This page displays the current Code Quiz player's score.                        -->
    <!-- The player may enter their initials and together with their current score will  -->
    <!-- will be saved in local storage (using JSON) as an object of player high scores  -->
    <!--                                                            RJG  Feb 10, 2020    -->

    <section class="container">
        
        <div class="col text-center mt-5">
            <h3>All Done!</h3>
        </div>
        <br>
        <div class="col offset-3">
            <h4>Your final score is: <span id="plr-score"></span></h4>  
        </div>
        <br>
        <div class="row">
            <div class="col offset-3">
               <h4>Enter initials:</h4>  
           </div>
           <div class="col">
               <!-- <label for="todo-text">Enter initials:</label> -->
                <!-- <input type="text" name="player-initials" id="player-initials"/> -->
                <!-- <form id="initials">
                    <input type="text" name="player-initials" id="player-initials" />
                </form> -->
                <!-- <p id="player"><input type="text" id="player-initials" /></p> -->
              <form id="intl-form" method="POST">
                  <label for="intl-text"></label>
                  <input type="text" name="intl-text" id="intl-text" />
               </form>
           </div>
           <div class="col">
             <button id="submit">Submit</button>
           </div>

       </div>

    </section>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <script>
        //  define global variables

        //var playerInitials = document.querySelector("#player-initials");
        //var initials       = document.querySelector("#initials");
        var submitBtn      = document.querySelector("#submit");

        var intlInput      = document.querySelector("#intl-text");
        var intlForm       = document.querySelector("#intl-form");
                
        //  get player score from local storage
    
        var player_score = localStorage.getItem("playerScore");
        console.log(player_score);  //, "playerScore");

        var plrScore = document.getElementById("plr-score");
        plrScore.textContent = player_score;

        // Add event listener to submit button
        submitBtn.addEventListener("click", saveHighscore);

        function saveHighscore () {
        
            var intlText        = intlInput.value.trim();
            var player_initials = intlText.toUpperCase();
            console.log("player initials: ", player_initials);

            //  get High Scores from local storage
        
            var data        = localStorage.getItem("highScores");

            if (!data) {
                // create new high_scores array
                var high_scores = [];
            } else {
                var high_scores = JSON.parse(data);
            }
            console.log(high_scores);
            //-----------------------------------------------------------------------------------------------
            // search high_scores array for entry with current player initials.
            // if not found then add the new player object to the array, otherwise (it already exists)
            // so check scores and update player entry with new score if it is higher.
            // if array was updated then sort it by descending score value. 
            //-----------------------------------------------------------------------------------------------

            // search array for entry with current player initials

            var playerIndex = -1;
            var playerUpdated = false;
            high_scores.forEach(checkForPlayer);

            function checkForPlayer(hsEntry, index, array) {
                if (hsEntry.player === player_initials) {
                    // current player already exists in high_scores array
                    playerIndex = index;
                    if (hsEntry.score < player_score) {
                        // update player entry with new score if it is higher
                        console.log("player high score updated");
                        hsEntry.score = player_score;
                        playerUpdated = true;
                    }
                }
            }
            console.log("player index: ", playerIndex);

            if (playerIndex === -1) {
                // current player was not found in high_scores array, so add it
                console.log("current player is new");
                // create a new player-score object
                var newPlayerScore = new Player(player_initials, player_score);
                console.log("New player score obj: ", newPlayerScore);
                // Add new player score to high_scores array
                high_scores.push(newPlayerScore);
                playerUpdated = true;
            }

            if (playerUpdated && high_scores.length > 1) {
                // sort into descending high score sequence
                high_scores.sort(function(a, b){return b.score - a.score});
            }
            console.log(high_scores);

            // Save updated high scores array in local storage
            localStorage.setItem("highScores", JSON.stringify(high_scores));
            
            // transfer to 'Highscores' page
            window.location.href = "highscores.html";

        }

        // Constructor function for Player objects in High Scores array

        function Player(initials, score) {
                this.player = initials;
                this.score  = score;
        }

    </script>

</body>

</html>